---
title: 愉快的本地开发体验之本地DNS
comments: true
fancybox: false
toc: true
permalink: happy-dev-run-local-dns-server
date: 2021-05-01 10:42:11
tags:
- docker
- dns
categories:
- 技术相关
- docker
description:
top:
---
## 写在前面

童鞋们，大家在本地环境进行联调或者运行一些服务的时候，是不是经常通过 `ip:port` 进行测试。有时候服务一多，经常性的需要记住很多 `ip:port` 信息。

那么如何通过自定义域名的方式去，替换 `ip:port`，减去我们的记忆负担，提升我们的开发体验。

<!--more-->

## 方案一：修改本地 `Hosts` 文件

这里推荐一款工具，[SwitchHosts](https://swh.app/zh/)（*记忆中，之前的版本叫做 `SwitchHosts!`*），页面简洁，操作一目了然。

配置 Hosts 文件，只需要将域名的地址跟 IP 做映射即可。
![SwitchHosts](https://static.aliyun.xkcoding.com/2021/09/03/16305752555388.jpg?x-oss-process=style/tag_compress)

测试

```bash
➜  ~ ping a.dev.io
PING a.dev.io (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.098 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.086 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.093 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.118 ms
64 bytes from 127.0.0.1: icmp_seq=4 ttl=64 time=0.112 ms
^C
--- a.dev.io ping statistics ---
5 packets transmitted, 5 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.086/0.101/0.118/0.012 ms
```

修改 Hosts 文件这种方式，如果我们在本机又部署了一个 b 服务，此时需要加一个 `b.dev.io`，则需要额外新增一条记录，并不能做到泛域名解析（`*.dev.io`）。如果要在本地支持泛域名解析，那么就只能通过方案二来实现了。

## 方案二：dnsmasq

原生的 dnsmasq 是不具备界面的，这里推荐一款带有 web 界面的 `dnsmasq`，同时还支持「Hot Reload」机制。

我们通过 docker 快速启动一个 dnsmasq 服务，首先新建一个配置文件 `dnsmasq.conf`，并将配置文件存放在 config 目录下。

```conf
log-queries
no-resolv
server=8.8.8.8
server=114.114.114.114
strict-order

address=/dev.io/127.0.0.1
```

这里我们使用 `jpillora/dnsmasq:latest` 这个镜像，下面是编排文件：

```yaml
version: "3.8"

services:
  dns-server:
    image: jpillora/dnsmasq:latest
    ports:
        - "53:53/udp"
        - 8080:8080
    environment:
      - HTTP_USER=root
      - HTTP_PASS=root
    volumes:
      - ./config/dnsmasq.conf:/etc/dnsmasq.conf
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
```

运行 `docker-compose up` 启动服务，访问管理界面 http://localhost:8080

![dnsmasq管理界面](https://static.aliyun.xkcoding.com/2021/09/03/16305767071171.jpg?x-oss-process=style/tag_compress)

测试（记得把方案一的 Hosts 记录重置一下😉）

```bash
➜  ~ ping a.dev.io
ping: cannot resolve a.dev.io: Unknown host
```

哦豁，失败了，需要修改本机 DNS 配置，如图所示：
![DNS配置](https://static.aliyun.xkcoding.com/2021/09/03/16305773370388.jpg?x-oss-process=style/tag_compress)

再次测试

```bash
➜  ~ ping a.dev.io
PING a.dev.io (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.043 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.044 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.133 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.144 ms
64 bytes from 127.0.0.1: icmp_seq=4 ttl=64 time=0.130 ms
^C
--- a.dev.io ping statistics ---
5 packets transmitted, 5 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.043/0.099/0.144/0.045 ms
```

此时，如果测试一下 `b.dev.io` 呢？

```bash
➜  ~ ping b.dev.io
PING b.dev.io (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.052 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.143 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.142 ms
^C
--- b.dev.io ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.052/0.112/0.143/0.043 ms
```

没错，天然支持泛域名解析，还记得我们上面的配置么？
```conf
address=/dev.io/127.0.0.1
```
这里配置就意味着 `*.dev.io` 都会指向到 `127.0.0.1`。

## 方案三：go-dnsmasq（2021.09.01 更新）

> 运行了一段时间方案二之后，发现我的 MBP 越来越卡，通过 docker stats 发现可能存在内存泄漏的问题。此时强大的苏大出现了！

[苏大](https://github.com/soulteary) 提供了一个魔改的船新版本 https://github.com/soulteary/go-dnsmasq ，同时提供了一个仅 2.7M 左右的容器镜像，同时解决了内存泄漏的问题。

> 无奈，该版本的镜像，未适配 arm64 架构，导致无法在 M1 芯片的 Mac 上测试，后面测试之后，再完善本文。

---

下一篇，我们来聊聊如果通过 Traefik 代理本地容器服务来提升本地的开发体验。

## 参考

- https://little-star.love/posts/f114e298/
- https://soulteary.com/2021/08/19/dns-for-local-development.html
